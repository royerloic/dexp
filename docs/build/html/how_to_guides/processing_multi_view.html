<!doctype html>
<html class="no-js">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><link rel="index" title="Index" href="../genindex.html" /><link rel="search" title="Search" href="../search.html" /><link rel="next" title="Implementing your own processing pipeline" href="implementing_processing.html" /><link rel="prev" title="Visualizing your data" href="visualization.html" />

    <meta name="generator" content="sphinx-4.4.0, furo 2022.01.02"/>
        <title>Processing a multi-view dataset using DEXP CLI - dexp documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo.css?digest=df49af52631e7917044a9c21a57f7b83170a6dd0" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo-extensions.css?digest=fade93df149f7c5fedb3ff897f799dc7d283b420" />
    
    


<style>
  body {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  
  }
  body[data-theme="dark"] {
    --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
  }
  @media (prefers-color-scheme: dark) {
    body:not([data-theme="light"]) {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
  }
</style></head>
  <body>
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
      <path stroke="none" d="M0 0h24v24H0z" />
      <line x1="4" y1="6" x2="20" y2="6" />
      <line x1="10" y1="12" x2="20" y2="12" />
      <line x1="6" y1="18" x2="20" y2="18" />
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-half" viewBox="0 0 24 24">
    <title>Auto light/dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-shadow">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
      <circle cx="12" cy="12" r="9" />
      <path d="M13 12h5" />
      <path d="M13 15h4" />
      <path d="M13 18h1" />
      <path d="M13 9h4" />
      <path d="M13 6h1" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../index.html"><div class="brand">dexp  documentation</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../index.html">
  
  
  <span class="sidebar-brand-text">dexp  documentation</span>
  
</a><form class="sidebar-search-container" method="get" action="../search.html" role="search">
  <input class="sidebar-search" placeholder=Search name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <p class="caption" role="heading"><span class="caption-text">Getting started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../getting_started/install.html">Install</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting_started/contact_us.html">Contact us</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">How-to guides</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="data_conversion.html">Converting to our file format</a></li>
<li class="toctree-l1"><a class="reference internal" href="visualization.html">Visualizing your data</a></li>
<li class="toctree-l1 current current-page"><a class="current reference internal" href="#">Processing a multi-view dataset using DEXP CLI</a></li>
<li class="toctree-l1"><a class="reference internal" href="implementing_processing.html">Implementing your own processing pipeline</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Commands</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../commands/dexp_commands.html">Image processing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../commands/video_commands.html">Video rendering</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../api/introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/processing.html">Processing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/volume_render.html">Volume Render</a></li>
</ul>

</div>
</div>
      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <div class="content-icon-container">
          <div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main">
          <div class="section" id="processing-a-multi-view-dataset-using-dexp-cli">
<h1>Processing a multi-view dataset using DEXP CLI<a class="headerlink" href="#processing-a-multi-view-dataset-using-dexp-cli" title="Permalink to this headline"></a></h1>
<p>In this example, we will show how to process the multi views acquired by our multi-view light-sheet microscope <a class="reference external" href="#1">[1]</a> to
obtain a single fused image.</p>
<p>The processing consists of two main steps:</p>
<ul class="simple">
<li><p>Fusion: to fuse the multiple views into a single image.</p></li>
<li><p>Deconvolution: to reduce the illumination spread from the acquisition process. Ideally, we would know the true point spread function (PSF), usually we don’t have access to this and use the theoretical PSF calculated from the imaging system parameters.</p></li>
</ul>
<p>One could also invert the processing steps by deconvolving each view separately and then fusing, while this could improve the final result the processing time will be much longer.</p>
<p>To reproduce this tutorial you can <a class="reference external" href="https://drive.google.com/file/d/1W9ysPcup6iW7E1CzTL2c1oERwBn8pj0D/view?usp=sharing">download a sample</a> of a single time point with 4 views from the combination of two cameras (C0 and C1) and two light sheets (L0 and L1) of a Zebra-fish embryo. This dataset will be referred as <code class="docutils literal notranslate"><span class="pre">demo_4views.zarr.zip</span></code>.</p>
<p>NOTE: We recommend to avoid using the <code class="docutils literal notranslate"><span class="pre">.zarr.zip</span></code> format and use <code class="docutils literal notranslate"><span class="pre">.zarr</span></code> because it can lead to <strong>data corruption</strong> if a process is interrupted without closing the opened file. Here we used the <code class="docutils literal notranslate"><span class="pre">.zarr.zip</span></code> to share the file more easily and the remaining data is stored with only <code class="docutils literal notranslate"><span class="pre">.zarr</span></code>.</p>
<div class="section" id="inspecting-the-dataset">
<h2>Inspecting the dataset<a class="headerlink" href="#inspecting-the-dataset" title="Permalink to this headline"></a></h2>
<p>We can inspect the dataset through the command line using <code class="docutils literal notranslate"><span class="pre">dexp</span> <span class="pre">info</span></code></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ dexp info demo_4views.zarr.zip
</pre></div>
</div>
<p>This dumps a bunch of information, one of them being the zarr structure tree, which shows that our dataset contains 4 different channels named <code class="docutils literal notranslate"><span class="pre">['488-C0L0',</span> <span class="pre">'488-C0L1',</span> <span class="pre">'488-C1L0',</span> <span class="pre">'488-C1L1']</span></code>, each one containing an image with shape <code class="docutils literal notranslate"><span class="pre">(1,</span> <span class="pre">407,</span> <span class="pre">2048,</span> <span class="pre">2048)</span></code> representing the time, z, y, and x axes, and their marginal projections (e.g., <code class="docutils literal notranslate"><span class="pre">488-C0L0_projection_0</span></code>).</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>...
├╗ Information on dataset at: ['demo_4views.zarr.zip']
│├ Dataset at location: demo_4views.zarr.zip
││ Channels: ['488-C0L0', '488-C0L1', '488-C1L0', '488-C1L1']
││ Zarr tree:
││ /
││  ├── 488-C0L0
││  │   ├── 488-C0L0 (1, 407, 2048, 2048) uint16
││  │   ├── 488-C0L0_projection_0 (1, 2048, 2048) uint16
││  │   ├── 488-C0L0_projection_1 (1, 407, 2048) uint16
││  │   └── 488-C0L0_projection_2 (1, 407, 2048) uint16
││  ├── 488-C0L1
││  │   ├── 488-C0L1 (1, 407, 2048, 2048) uint16
││  │   ├── 488-C0L1_projection_0 (1, 2048, 2048) uint16
││  │   ├── 488-C0L1_projection_1 (1, 407, 2048) uint16
││  │   └── 488-C0L1_projection_2 (1, 407, 2048) uint16
││  ├── 488-C1L0
││  │   ├── 488-C1L0 (1, 407, 2048, 2048) uint16
││  │   ├── 488-C1L0_projection_0 (1, 2048, 2048) uint16
││  │   ├── 488-C1L0_projection_1 (1, 407, 2048) uint16
││  │   └── 488-C1L0_projection_2 (1, 407, 2048) uint16
││  └── 488-C1L1
││      ├── 488-C1L1 (1, 407, 2048, 2048) uint16
││      ├── 488-C1L1_projection_0 (1, 2048, 2048) uint16
││      ├── 488-C1L1_projection_1 (1, 407, 2048) uint16
││      └── 488-C1L1_projection_2 (1, 407, 2048) uint16.
...
</pre></div>
</div>
<p>Additionally, we can check the command line history, that stores the command used to generate this dataset. In this case, a dataset was created in <code class="docutils literal notranslate"><span class="pre">napari</span></code> when viewing an image named <code class="docutils literal notranslate"><span class="pre">embryo_4views.tif</span></code>, and later this data was copied from <code class="docutils literal notranslate"><span class="pre">.zarr</span></code> to <code class="docutils literal notranslate"><span class="pre">.zarr.zip</span></code>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>...
││ Command line history:
││  ├──■ 'napari embryo_4views.tif'
││  └──■ 'dexp copy demo_4views.zarr -o demo_4views.zarr.zip'
...
</pre></div>
</div>
</div>
<div class="section" id="fusion">
<h2>Fusion<a class="headerlink" href="#fusion" title="Permalink to this headline"></a></h2>
<p>To fuse a dataset we must first register the views from different cameras. We assume the displacement (i.e., translation) between cameras is constant through out the multiple frames (considering the general case, here we have a single time point). Therefore, we summarize the registration parameters as the median displacement between all time points. This parameters are saved in the <code class="docutils literal notranslate"><span class="pre">registration_models.txt</span></code> by default.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">-c</span></code> flag indicates the channels we are using to register the views, this is not necessary when all channels should be considered, which is not always the case.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ dexp register demo_4views.zarr.zip -c <span class="m">488</span>-C0L0,488-C0L1,488-C1L0,488-C1L1
</pre></div>
</div>
<p>With this we can fuse the views, the options <code class="docutils literal notranslate"><span class="pre">--pad</span></code> indicates the data should be padded when aligning the views, and <code class="docutils literal notranslate"><span class="pre">--loadreg</span></code> that it should load the registration models and not compute it during processing.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ dexp fuse demo_4views.zarr.zip --pad --loadreg -c <span class="m">488</span>-C0L0,488-C0L1,488-C1L0,488-C1L1
</pre></div>
</div>
<p>By default the output is saved with an additional <code class="docutils literal notranslate"><span class="pre">_fused</span></code> to its name. Hence, we can visualize its results using (package <code class="docutils literal notranslate"><span class="pre">napari-dexp</span></code> is required.)</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ napari demo_4views_fused.zarr
</pre></div>
</div>
<p>Notice that the fused dataset contains only a single image.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ dexp info demo_4views_fused.zarr
...
├╗ Information on dataset at: ['demo_4views_fused.zarr']
│├ Dataset at location: demo_4views_fused.zarr
││ Channels: ['fused']
││ Zarr tree:
││ /
││  └── fused
││      ├── fused (1, 408, 2048, 2078) uint16
││      ├── fused_projection_0 (1, 2048, 2078) uint16
││      ├── fused_projection_1 (1, 408, 2078) uint16
││      └── fused_projection_2 (1, 408, 2048) uint16.
...
</pre></div>
</div>
</div>
<div class="section" id="deconvolution">
<h2>Deconvolution<a class="headerlink" href="#deconvolution" title="Permalink to this headline"></a></h2>
<p>For the deconvolution you need to provide information of your microscopes PSF. The PSFs from our microscopes are already available through the <code class="docutils literal notranslate"><span class="pre">--objective</span> <span class="pre">(-obj)</span></code> flag, you can change their configuration with the <code class="docutils literal notranslate"><span class="pre">dxy,</span> <span class="pre">dz,</span> <span class="pre">na</span></code> of your acquisition system, or open a github issue to discuss the addition of other PSFs. We also use the option <code class="docutils literal notranslate"><span class="pre">--max-correction</span> <span class="pre">(-mc)</span></code> to limit the multiplicative correction of lucy-richardson deconvolution to avoid numerical errors caused by the very large values from deconvolving the beads present in this dataset — this is not necessary most of the time.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ dexp deconv demo_4views_fused.zarr -obj nikon16x08na -mc <span class="m">5</span>
</pre></div>
</div>
<p>Finally, the data processing is done and the final dataset can be visualized with:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ napari demo_4views_fused_deconv.zarr
</pre></div>
</div>
<p>And the command line history reports what operations were used to produce it:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ dexp info demo_4views_fused_deconv.zarr
...
││ Command line history:
││  ├──■ 'napari embryo_4views.tif'
││  ├──■ 'dexp copy demo_4views.zarr -o demo_4views.zarr.zip'
││  ├──■ 'dexp fuse demo_4views.zarr.zip --pad --loadreg -c 488-C0L0,488-C0L1 488-C1L0,488-C1L1'
││  └──■ 'dexp deconv demo_4views_fused.zarr -obj nikon16x08na -mc 5
...
</pre></div>
</div>
<p>We encourage you to play with the other parameters to obtain the optimal results. Their description can be found through <code class="docutils literal notranslate"><span class="pre">dexp</span> <span class="pre">--help</span></code> or <code class="docutils literal notranslate"><span class="pre">dexp</span> <span class="pre">&lt;command</span> <span class="pre">(e.g.</span> <span class="pre">deconv)&gt;</span> <span class="pre">--help</span></code>.</p>
</div>
<div class="section" id="references">
<h2>References<a class="headerlink" href="#references" title="Permalink to this headline"></a></h2>
<p><span class="raw-html-m2r"><a id="1">[1]</a></span>
Royer, Loïc A., et al.
“Adaptive light-sheet microscopy for long-term, high-resolution imaging in living organisms.”
Nature biotechnology 34.12 (2016): 1267-1278.</p>
</div>
</div>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="implementing_processing.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">Implementing your own processing pipeline</div>
              </div>
              <svg><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="visualization.html">
              <svg><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">Visualizing your data</div>
                
              </div>
            </a>
        </div>

        <div class="related-information">
              Copyright &#169; 2021. Chan Zuckerberg Biohub. All rights reserved |
          Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
          <a href="https://github.com/pradyunsg/furo">Furo theme</a>.
            | <a class="muted-link" href="../_sources/how_to_guides/processing_multi_view.md.txt"
               rel="nofollow">
              Show Source
            </a>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            Contents
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">Processing a multi-view dataset using DEXP CLI</a><ul>
<li><a class="reference internal" href="#inspecting-the-dataset">Inspecting the dataset</a></li>
<li><a class="reference internal" href="#fusion">Fusion</a></li>
<li><a class="reference internal" href="#deconvolution">Deconvolution</a></li>
<li><a class="reference internal" href="#references">References</a></li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/scripts/furo.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    </body>
</html>